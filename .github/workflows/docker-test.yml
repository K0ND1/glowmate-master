name: Docker Test Suite

on:
  pull_request:
    branches:
      - master
      - dev
    paths:
      - 'backend/**'
      - '.github/workflows/**'

jobs:
  # Test budowania obrazu API
  test-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: glowmate-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Test docker-compose (wszystko w jednym)
  test-compose-all:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          cd backend
          docker-compose config
          echo "âœ… docker-compose.yml is valid"

      - name: Test all-in-one setup
        run: |
          cd backend
          docker-compose up -d
          
          echo "â³ Waiting for services to be ready..."
          sleep 15
          
          echo "ğŸ“Š Container status:"
          docker-compose ps
          
          echo "ğŸ“ API logs:"
          docker-compose logs api
          
          echo "ğŸ§ª Testing health endpoint..."
          curl -f http://localhost:3000/ || echo "âš ï¸ Health check failed"

      - name: Cleanup
        if: always()
        run: |
          cd backend
          docker-compose down -v

  # Test docker-compose split
  test-compose-split:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate infrastructure compose
        run: |
          cd backend
          docker-compose -f docker-compose.infra.yml config
          echo "âœ… docker-compose.infra.yml is valid"

      - name: Validate API compose
        run: |
          cd backend
          docker-compose -f docker-compose.api.yml config
          echo "âœ… docker-compose.api.yml is valid"

      - name: Test init-db.sh syntax
        run: |
          cd backend
          if [ -f init-db.sh ]; then
            bash -n init-db.sh
            echo "âœ… init-db.sh syntax is valid"
          fi

      - name: Test split setup (infra + api)
        run: |
          cd backend
          
          echo "ğŸš€ Starting infrastructure..."
          docker-compose -f docker-compose.infra.yml up -d
          
          echo "â³ Waiting for database to be ready..."
          sleep 15
          
          echo "ğŸ“Š Infrastructure status:"
          docker-compose -f docker-compose.infra.yml ps
          
          echo "ğŸš€ Starting API..."
          docker-compose -f docker-compose.api.yml up -d
          
          echo "â³ Waiting for API to be ready..."
          sleep 15
          
          echo "ğŸ“Š API status:"
          docker-compose -f docker-compose.api.yml ps
          
          echo "ğŸ“ API logs:"
          docker-compose -f docker-compose.api.yml logs
          
          echo "ğŸ§ª Testing health endpoint..."
          curl -f http://localhost:3000/ || echo "âš ï¸ Health check failed"

      - name: Cleanup
        if: always()
        run: |
          cd backend
          docker-compose -f docker-compose.api.yml down -v || true
          docker-compose -f docker-compose.infra.yml down -v || true
